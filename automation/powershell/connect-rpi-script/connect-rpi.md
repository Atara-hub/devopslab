# Скрипт Connect-Device для PowerShell
# (engineering-style, plain text, UTF-8)

Описание
--------
PowerShell-утилита для автоматического поиска устройства в локальной сети по MAC-адресу и последующего подключения по SSH.  
Работает в двух режимах: интерактивное меню (3 пункта) или прямой вызов с параметрами.  
При отсутствии записи в ARP выполняет параллельный ping-sweep /24 за 30 с (PowerShell Jobs).

Функционал
----------
- Поиск по MAC в таблице ARP  
- Параллельное сканирование сети при необходимости  
- Интерактивное меню: Raspberry Pi / Local server / Ручной ввод MAC  
- Настраиваемые параметры через аргументы скрипта  
- Чистый вывод и коды возврата для пайплайнов и CI  

Установка
---------
1. Сохранить скрипт как Connect-Device.ps1  
2. Разрешить выполнение (один раз для пользователя):  
   Set-ExecutionPolicy RemoteSigned -Scope CurrentUser  
3. Убедиться, что ssh.exe доступен в PATH (встроен в Windows 10/11).

Базовые параметры скрипта
-------------------------
-Можно изменить в теле скрипта или передать через аргументы:

$DefaultMacAddress = "aa-bb-cc-dd-ee-01"   # Raspberry Pi  
$LocalServerMac    = "aa-bb-cc-dd-ee-02"   # Local server  
$DefaultUser       = "piuser"              # пользователь по умолчанию  
$Gateway           = "192.168.1.1"         # шлюз для обновления ARP  
$NetworkRange      = "192.168.1"           # сеть /24 для сканирования

Использование
-------------
# Интерактивный выбор (меню 0-1-2)
.\Connect-Device.ps1

# Прямой запуск с нужным MAC и пользователем
.\Connect-Device.ps1 -MacAddress aa-bb-cc-dd-ee-02 -User srvuser

# Полный список параметров
.\Connect-Device.ps1 -MacAddress <MAC> -User <username> -Gateway <ip> -Network <prefix>

Логика работы
-------------
1. Пингует шлюз для обновления ARP.  
2. Ищет MAC в текущей таблице ARP.  
3. Если не найдено — предлагает параллельный ping-sweep 1-254 (Jobs, 30 с).  
4. При обнаружении IP автоматически подключается по SSH.  
5. Возвращает код завершения SSH (0 — успешно, 1 — ошибка поиска или отмена).

Коды выхода
-----------
0  – SSH завершён успешно  
1  – устройство не обнаружено или пользователь отменил скан

Производительность
------------------
- Последовательный ping 254 адресов: 5-10 мин  
- Параллельные Jobs: 10-30 с при типичной загрузке сети  
- Память: jobs принудительно останавливаются/удаляются после таймаута

Типичные проблемы
-----------------
Устройство не появляется в ARP:  
- Проверьте, что хост включен и в той же подсети.  
- Убедитесь, что MAC записан в правильном формате (xx-xx-xx-xx-xx-xx).  

SSH не подключается:  
- На целевом хосте должен работать sshd.  
- Проверьте имя пользователя и ключ/пароль.  
- Убедитесь, что брандмауэр не блокирует TCP/22 (или другой порт SSH).

Требования
----------
- Windows PowerShell 5.1 или PowerShell 7+  
- Клиент OpenSSH в PATH  
- Доступ к сети целевого устройства  
- Запущенный SSH-сервер на целевом хосте

Настройка пост-меню на Raspberry Pi (опционально)
-------------------------------------------------
Если после обычного exit нужно показать выбор «1 – прыгнуть на admin-сервер / 2 – остаться в Pi»:

1. Создать обёртку:
   nano ~/.pi_welcome.sh

   #!/bin/bash
   echo "=== Post-SSH menu ==="
   echo "1) Connect to admin server (10.20.30.40)"
   echo "2) Exit to Pi shell"
   read -p "Select (1-2): " choice
   case $choice in
     1) ssh adminuser@10.20.30.40 ;;
     2) exec bash ;;
     *) exec bash ;;
   esac
   exec bash

2. Сделать исполняемым:
   chmod +x ~/.pi_welcome.sh

3. Добавить вызов в профиль:
   echo '[[ -f ~/.pi_welcome.sh ]] && . ~/.pi_welcome.sh' >> ~/.bash_profile

Теперь каждый вход по SSH завершится показом меню до тех пор, пока пользователь не выйдет из него.

Лицензия
--------
Скрипт предоставляется "как есть".  
Можете свободно изменять и распространять в соответствии с внутренними процедурами.
